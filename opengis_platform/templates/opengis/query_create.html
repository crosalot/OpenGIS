{% extends "./opengis/content_base.html" %}
{% load opengis_tags %}

{% block head_content %}
<script type="text/javascript" src="{{MEDIA_URL}}/scripts/scripts.js"></script>
<script type="text/javascript">
$(document).ready(function() {
	$("select.starter_selector").change(function() {
		var select_object = $(this);
		var table_type = $(this).find("option:selected").val();
		
		$(this).parent().find("select.table_selector").remove();
		
		if(table_type == "mine") {
			$.getJSON("{% url opengis_api_table_list %}", function(data) {
				var list_html = '';
				for(var i in data.result) {
					list_html += '<option value="' + data.result[i].id + '">' + data.result[i].name + '</option>';
				}
				
				select_object.parent().append('<select class="table_selector"><option></option>' + list_html + '</select>');
				
				select_object.parent().find("select.table_selector").change(function() {
					loadMasterTables($(this).find("option:selected").val());
				});
			});
		
		} else if(table_type == "others") {
			
			
			
		} else if(table_type == "builtin") {
			$(this).parent().append('<select class="table_selector"><option></option>{% generate_built_in_table_list %}</select>');
			
			$(this).parent().find("select.table_selector").change(function() {
				loadMasterTables($(this).find("option:selected").val());
			});
		}
	
	});
	
	$("form button[type='submit']").click(function() {
		submit();
		return false;
	});
});

function loadMasterTables(table_code) {
	$.getJSON("{% url opengis_api_table_info %}?table_code=" + table_code, function(data) {
		if(data.response == "success") {
			$("#starter_panel").html(drawTable(data.result[0]) + '<div class="manage_filters_popup" style="display:none;"></div>');
			
			$("#starter_panel a.manage-filters").click(function() {
				show_construct_query_manage_filters_popup($(this));
				
				return false;
			});
		}
		
		$("child-layer").remove();
	});
}

function loadChildTables(table_code) {
	
}

function drawTable(table_info) {
	var html = '<table rel="' + table_info.id + '"><tr><th>' + table_info.name + '</th></tr><tr><td class="actions"><a href="#" class="manage-filters" title="Filter"><img src="{{MEDIA_URL}}/images/query_filter.png"/>Filter</a> <a href="#" title="Aggregate"><img src="{{MEDIA_URL}}/images/query_aggregate.png"/>Aggregate</a> <a href="#" title="Sort By"><img src="{{MEDIA_URL}}/images/query_sort.png"/>Sort</a></td></tr>';
	var selector = '';
	
	for(var i=0; i<table_info.columns.length; i++) {
		html += '<tr><td rel="' + table_info.columns[i].id + '"><input type="checkbox" class="display" rel="' + table_info.columns[i].physical_name + '"/> ' + table_info.columns[i].name + '</td></tr>'
		selector += '<option value="' + table_info.columns[i].id + '">' + table_info.columns[i].name + '</option>';
	}
	
	html += '</table><select class="rendered_columns" style="display:none;"><option></option>' + selector + '</select>';
	return html;
}

function submit() {
	var query_name = $("form input[name='query_name']").val();
	var query_description = $("form textarea[name='query_description']").val();
	var starter_table = $("#starter_panel table").attr('rel');
	
	var display_columns = new Array();
	$(".query_builder .tables input.display[type='checkbox']:checked").each(function() {
		var parentTable = $(this).closest('table');
		
		if(parentTable.parent().attr('id') != "starter_panel") {
			display_columns.push(parentTable.attr('rel') + "." + $(this).attr('rel'));	
		} else {
			display_columns.push($(this).attr('rel'));
		}
	});
	
	console.log(display_columns);
	
	// Filters
	var filter_columns = new Array();
	$(".table_panel .manage_filters_popup li.filter").each(function() {
		var function_name = $(this).find(".function option:selected").val();
		
		if(function_name == "equal") {
			var column_id = $(this).find(".criteria select option:selected").val();
			var criteria_value = $(this).find(".criteria input[name='value']").val();
			
			if($(this).find(".parameter-checkbox").attr("checked")) {
				filter_columns.push('{"function":"' + function_name + '","column_id":"' + column_id + '"}');
			} else {
				filter_columns.push('{"function":"' + function_name + '","column_id":"' + column_id + '","value":"' + criteria_value + '"}');
			}
		}
	});
	
	$(".button_panel .loading").show();
	
	$.post("{% url opengis_api_query_create %}", {query_name:query_name, query_description:query_description, starter_table:starter_table, display:display_columns, filter:filter_columns}, function(data) {
		$(".button_panel .loading").hide();
		
		/*if(data.response == 'success') {
			window.location = "http://" + window.location.host + "/my/table/" + data.result.table_name + "/";
		}*/
	}, "json");
}
</script>
{% endblock %}

{% block sub_body_content %}
<div class="page_header"><h2>Create New Query</h2></div>

<div class="style_query_create">
	<form action="." method="post" class="std_form">
		<ul class="form">
			<li class="long_textbox"><label for="id_query_name">Query Name:</label><input type="text" name="query_name"/></li>
			<li class="medium_textarea"><label for="id_description">Description:</label><textarea name="query_description"></textarea></li>
		</ul>
		<div class="query_builder">
			<label class="caption">Query Builder</label>
			<div class="starter_table">
				<label>Select Table:</label>
				<select class="starter_selector"><option></option><option value="mine">My Tables</option><option value="others">User's Table</option><option value="builtin">Built-in Table</option></select>
			</div>
			<div class="tables">
				<div id="starter_panel" class="table_panel"></div>
			</div>
		</div>
		
		<div class="button_panel">
			<button type="submit">Save Query</button>
			<a href="#">Preview</a>
			<img src="{{MEDIA_URL}}/images/loading.gif" class="loading" style="display:none;"/>
		</div>
	</form>
</div>

<div id="manage_query_filter_popup" style="display:none;">
	<div class="close_panel"><a href="#">Close</a></div>
	<h4>Filters</h4>
	<ul class="filters">
		<li class="filter"><span class="function"><select><option>Equals</option></select></span><span class="criteria"><select><option>Column 1</option></select> = <input type="text" /></span><button class="remove-filter">Remove</button></li>
		<li><a href="#" class="add-filter">Add new filter</a></li>
	</ul>
</div>
{% endblock %}