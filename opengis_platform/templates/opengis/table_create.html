{% extends "./opengis/content_base.html" %}
{% load opengis_tags %}

{% block head_content %}
<script type="text/javascript">
$(document).ready(function() {
	$(".columns_form select").change(function() {
		var data_type = $(this).find("option:selected").val();
		
		if(data_type == "datetime") {
			$(this).parent().find(".more_inputs").html('<select class="related"><option></option><option value="datetime">Date and Time</option><option value="date">Date only</option><option value="time">Time only</option></select>');
		
		} else if(data_type == "builtin") {
			$(this).parent().find(".more_inputs").html('<select class="related"><option></option>{% generate_built_in_table_list %}</select>');
		
		} else if(data_type == "table") {
			$(this).parent().find(".more_inputs").html('<select class="related"><option></option><option value="mine">My Tables</option><option value="others">User\'s Table</option></select>');
			
			$(this).parent().find(".more_inputs select").change(function() {
				var select_object = $(this);
				var table_type = $(this).find("option:selected").val();
				
				$(this).parent().find("select.data_type_table_tyle").remove();
				
				if(table_type == "mine") {
					$.getJSON("{% url opengis_ajax_list_user_table %}", function(data) {
						var list_html = '';
						for(var i in data.tables) {
							list_html += '<option value="' + data.tables[i].id + '">' + data.tables[i].name + '</option>';
						}
						
						select_object.parent().append('<select class="data_type_table_tyle"><option></option>' + list_html + '</select>');
					});
				
				} else if(table_type == "others") {
					// TODO Open Popup to ask for username, table code etc.
					
				}
			});
		
		} else {
			$(this).parent().find(".more_inputs").html('');
		}
	});
	
	// Add new column click event
	$(".columns_form a").click(function() {
		var col_num = $(".columns_form ol li").length - 1; // -2+1
		$(".columns_form ol li:last").before('<li class="input"><label>Column ' + col_num + '</label><input type="text" /><select class="data_type"><option></option>{% generate_data_type_list %}</select><div class="more_inputs"></div><div class="clear"></div></li>');
		return false;
	});
	
	$("form button").click(function() {
		dosubmit();
		return true;
	});
});

function dosubmit() {
	$(".columns_form li.input").each(function() {
		var column_name = $(this).find("input").val();
		var data_type = $(this).find("select.data_type option:selected").val();
		
		if(column_name != "" && data_type != "") {
			var column_parameter = "";
			
			if(data_type == "datetime") {
				var datetime_type = $(this).find("select.related option:selected").val();
				if(datetime_type != "") column_parameter = column_name + ":" + datetime_type;
			
			} else if(data_type == "builtin") {
				var builtin_table_id = $(this).find("select.related option:selected").val();
				if(datetime_type != "") column_parameter = column_name + ":" + data_type + ":related--" + builtin_table_id;

			} else if(data_type == "table") {
				var table_type = $(this).find("select.related option:selected").val();
				var table_id = $(this).find("select.data_type_table_tyle option:selected").val();
				
				if(table_type != "" && table_id != "") column_parameter = column_name + ":" + table_type + ":related--" + table_id;

			} else {
				column_parameter = column_name + ":" + data_type;
			}
			
			if(column_parameter != "") {
				$("form").append('<input type="hidden" name="columns" value="' + column_parameter + '"/>');
			}
		}
	});
}
</script>
{% endblock %}

{% block sub_body_content %}
<div class="table_page_header"><h3>Create Table</h3></div>

<div class="style_table_create">
	<form action="." method="post" class="std_form">
		<ul>
			<li class="long_textbox"><label for="id_table_name">Table Name:</label>{{form.table_name}}</li>
			<li class="medium_textarea"><label for="id_description">Description:</label>{{form.description}}</li>
			<li class="long_textbox"><label for="id_tags">Tags:</label>{{form.tags}}<div class="comment">* Example: thailand,female population,census</div></li>
		</ul>
		<div class="columns_form">
			<ol>
				<li class="caption"><div class="column_name">Column Name</div><div class="data_type">Data Type</div><div class="clear"></div></li>
				<li class="input"><label>Column 1</label><input type="text" /><select class="data_type"><option></option>{% generate_data_type_list %}</select><div class="more_inputs"></div><div class="clear"></div></li>
				<li class="input"><label>Column 2</label><input type="text" /><select class="data_type"><option></option>{% generate_data_type_list %}</select><div class="more_inputs"></div><div class="clear"></div></li>
				<li class="input"><label>Column 3</label><input type="text" /><select class="data_type"><option></option>{% generate_data_type_list %}</select><div class="more_inputs"></div><div class="clear"></div></li>
				<li class="input"><label>Column 4</label><input type="text" /><select class="data_type"><option></option>{% generate_data_type_list %}</select><div class="more_inputs"></div><div class="clear"></div></li>
				<li class="input"><label>Column 5</label><input type="text" /><select class="data_type"><option></option>{% generate_data_type_list %}</select><div class="more_inputs"></div><div class="clear"></div></li>
				<li><a href="#">Add new column</a></li>
			</ol>
		</div>
		<button type="submit">Create Table</button>
	</form>
</div>
{% endblock %}